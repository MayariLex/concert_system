{% extends "base.html" %}
{% block content %}

<h2 class="text-center mb-4" style="color: #d3adf7;">Book Seats for {{ concert[0] }}</h2>

<div class="text-center mb-4">
  <img src="{{ url_for('static', filename='posters/' + concert[1]) }}" width="300">
</div>

<!-- Legend -->
<div class="legend text-center mb-4">
  <span class="legend-item"><span class="box available"></span> Available</span>
  <span class="legend-item"><span class="box selected"></span> Selected</span>
  <span class="legend-item"><span class="box sold"></span> Sold</span>
</div>

<!-- Stage -->
<div class="stage">STAGE</div>

<form method="POST" action="{{ url_for('purchase', concert_id=concert_id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="accordion" id="seatAccordion">
    {% for (cat_id, cat_name), seats in categories.items() %}
    <div class="accordion-item bg-dark border-purple mb-2">
      <h2 class="accordion-header" id="heading{{ cat_id }}">
        <button class="accordion-button collapsed bg-gradient-purple text-white"
                type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ cat_id }}"
                aria-expanded="false" aria-controls="collapse{{ cat_id }}">
          {{ cat_name }} - ₱{{ prices[cat_id] }}
        </button>
      </h2>
      <div id="collapse{{ cat_id }}" class="accordion-collapse collapse"
           aria-labelledby="heading{{ cat_id }}" data-bs-parent="#seatAccordion">
        <div class="accordion-body bg-black text-white">
          <div class="seat-grid">
            {% for seat in seats %}
            <button type="button" class="seat-btn {% if seat[2] == 'sold' %}sold{% else %}available{% endif %}"
                    data-id="{{ seat[0] }}"
                    data-label="{{ seat[1] }}"
                    data-price="{{ prices[cat_id] }}"
                    {% if seat[2] == 'sold' %}disabled{% endif %}>
              {{ seat[1] }}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <input type="hidden" name="seats" id="selected-seats-input">

  <div class="summary-box">
    <strong>Selected Seats:</strong> <span id="selected-seats">None</span><br>
    <strong>Total Price:</strong> ₱<span id="total-price">0</span>
  </div>

  <div class="text-center mt-4">
    <button type="submit" class="btn btn-success" style="padding: 12px 30px; background: linear-gradient(135deg, #2ecc71, #27ae60); border: none; border-radius: 25px; color: white; font-weight: 600;">Purchase</button>
  </div>
</form>

<!-- Style -->
<style>
  body {
    background-color: #000 !important;
    color: #fff;
  }

  .accordion-item.bg-dark {
    background-color: #111;
    border: 1px solid #8e44ad;
  }

  .bg-gradient-purple {
    background: linear-gradient(135deg, #8e44ad, #e91e63) !important;
  }

  .bg-black {
    background-color: #000 !important;
  }

  .accordion-button {
    font-weight: 600;
    font-size: 16px;
  }

  .seat-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding: 10px 0;
  }

  .seat-btn {
    width: 42px;
    height: 42px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    border: 1px solid #555;
    background: #222;
    color: white;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .seat-btn.available { background-color: #444; }
  .seat-btn.sold { background-color: #e74c3c; color: white; cursor: not-allowed; }
  .seat-btn.selected { background-color: #2ecc71; color: white; }

  .seat-btn:hover:not(.sold):not(.selected) {
    transform: scale(1.1);
    border-color: #8e44ad;
  }

  .stage {
    background-color: #8e44ad;
    color: white;
    text-align: center;
    padding: 12px;
    font-weight: bold;
    margin: 30px auto;
    width: 60%;
    border-radius: 10px;
    letter-spacing: 3px;
    box-shadow: 0 0 10px rgba(142, 68, 173, 0.5);
  }

  .legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
  }

  .legend-item {
    font-size: 15px;
    font-weight: 500;
    color: #ccc;
  }

  .box {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 5px;
  }

  .box.available { background-color: #999; }
  .box.selected { background-color: #2ecc71; }
  .box.sold { background-color: #e74c3c; }

  .summary-box {
    margin-top: 30px;
    font-size: 18px;
    text-align: center;
    color: #d3adf7;
  }
</style>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selectedSeats = new Set();
    const seatButtons = document.querySelectorAll(".seat-btn");

    function updateSummary() {
      const selectedArray = Array.from(selectedSeats);
      document.getElementById("selected-seats-input").value = selectedArray.join(",");

      const selectedLabels = Array.from(seatButtons)
        .filter(b => b.classList.contains("selected"))
        .map(b => b.getAttribute("data-label"));

      const total = Array.from(seatButtons)
        .filter(b => b.classList.contains("selected"))
        .map(b => parseFloat(b.getAttribute("data-price")))
        .reduce((sum, p) => sum + p, 0);

      document.getElementById("selected-seats").innerText = selectedLabels.length > 0 ? selectedLabels.join(", ") : "None";
      document.getElementById("total-price").innerText = total.toFixed(2);
    }

    seatButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const seatId = btn.getAttribute("data-id");
        if (btn.classList.contains("selected")) {
          btn.classList.remove("selected");
          selectedSeats.delete(seatId);
        } else {
          btn.classList.add("selected");
          selectedSeats.add(seatId);
        }
        updateSummary();
      });
    });
  });
</script>

<!-- Bootstrap (for accordion) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
