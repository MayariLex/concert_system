{% extends "base.html" %}
{% block content %}

<h2 class="text-center mb-4" style="color: #d3adf7;">Book Seats for {{ concert[0] }}</h2>

<div class="poster-layout-container">
  <!-- Concert Poster -->
  <div class="poster-section">
    <img src="{{ url_for('static', filename='posters/' + concert[1]) }}" width="390">
  </div>

  <!-- Visual Seat Layout -->
  <div class="layout-section">
    <h5 class="text-center mb-3" style="color: #d3adf7;">Venue Layout</h5>

    <!-- Arena-style venue layout -->
    <div class="arena-container">
      <!-- Stage -->
      <div class="arena-stage">STAGE</div>

      <!-- Venue Layout -->
      <div class="venue-layout" id="venue-layout">
        <!-- Will be populated by JavaScript based on layout -->
      </div>
    </div>
  </div>
</div>

<!-- Legend -->
<div class="legend text-center mb-4">
  <span class="legend-item"><span class="box available"></span> Available</span>
  <span class="legend-item"><span class="box selected"></span> Selected</span>
  <span class="legend-item"><span class="box sold"></span> Sold</span>
</div>

<form method="POST" action="{{ url_for('purchase', concert_id=concert_id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="accordion" id="seatAccordion">
    {% for (cat_id, cat_name), seats in categories.items() %}
    <div class="accordion-item bg-dark border-purple mb-2">
      <h2 class="accordion-header" id="heading{{ cat_id }}">
        <button class="accordion-button collapsed bg-gradient-purple text-white"
                type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ cat_id }}"
                aria-expanded="false" aria-controls="collapse{{ cat_id }}">
          {{ cat_name }} - ₱{{ prices[cat_id] }}
        </button>
      </h2>
      <div id="collapse{{ cat_id }}" class="accordion-collapse collapse"
           aria-labelledby="heading{{ cat_id }}" data-bs-parent="#seatAccordion">
        <div class="accordion-body bg-black text-white">
          <div class="seat-grid">
            {% for seat in seats %}
            <button type="button" class="seat-btn {% if seat[2] == 'sold' %}sold{% else %}available{% endif %}"
                    data-id="{{ seat[0] }}"
                    data-label="{{ seat[1] }}"
                    data-section="{{ cat_name }}"
                    data-index="{{ loop.index0 }}"
                    data-total="{{ seats|length }}"
                    data-price="{{ prices[cat_id] }}"
                    {% if seat[2] == 'sold' %}disabled{% endif %}>
              <span class="seat-code">{{ seat[1] }}</span>
            </button>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <input type="hidden" name="seats" id="selected-seats-input">

  <div class="summary-box">
    <strong>Selected Seats:</strong> <span id="selected-seats">None</span><br>
    <strong>Total Price:</strong> ₱<span id="total-price">0</span>
  </div>

  <div class="text-center mt-4">
    <button type="submit" class="btn btn-success" style="padding: 12px 30px; background: linear-gradient(135deg, #2ecc71, #27ae60); border: none; border-radius: 25px; color: white; font-weight: 600;">Purchase</button>
  </div>
</form>

<!-- Style -->
<!-- Style -->
<style>
  body {
    background-color: #000 !important;
    color: #fff;
  }

  /* Poster and Layout Container */
  .poster-layout-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .poster-section {
    flex: 0 0 auto;
  }

  .layout-section {
    flex: 0 0 auto;
    min-width: 400px; /* Reduced from 500px */
    max-width: 480px; /* Reduced from 600px */
  }

  /* Arena Container - Made smaller and more compact */
  .arena-container {
    background: linear-gradient(135deg, #2c1810, #1a1a2e);
    border: 2px solid #8e44ad;
    border-radius: 16px;
    padding: 20px; /* Reduced from 30px */
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(142, 68, 173, 0.3);
    max-width: 450px; /* Added max-width to constrain size */
    margin: 0 auto; /* Center the container */
  }

  /* Arena Stage - Made more compact */
  .arena-stage {
    background: linear-gradient(135deg, #e91e63, #8e44ad);
    color: white;
    text-align: center;
    padding: 12px; /* Reduced from 18px */
    font-weight: bold;
    margin-bottom: 20px; /* Reduced from 25px */
    border-radius: 12px;
    font-size: 16px; /* Reduced from 18px */
    letter-spacing: 3px; /* Reduced from 4px */
    box-shadow: 0 0 25px rgba(233, 30, 99, 0.8), inset 0 2px 4px rgba(255, 255, 255, 0.2);
    position: relative;
    z-index: 10;
    text-transform: uppercase;
  }

  /* Arena Layout - More compact spacing */
  .venue-layout {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; /* Reduced from 12px */
    position: relative;
    min-height: 300px; /* Reduced from 400px */
  }

  /* Arena Sections - Made smaller */
  .arena-section {
    position: relative;
    margin: 2px; /* Reduced from 4px */
    border-radius: 10px; /* Reduced from 12px */
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .arena-section:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
  }

  .section-block {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 1px;
    padding: 8px; /* Reduced from 12px */
    border-radius: 8px; /* Reduced from 10px */
    min-height: 35px; /* Reduced from 45px */
    position: relative;
  }

  .section-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px; /* Reduced from 12px */
    font-weight: 800;
    color: rgba(255, 255, 255, 0.95);
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.9);
    z-index: 5;
    pointer-events: none;
    text-align: center;
    line-height: 1.2;
    letter-spacing: 0.5px; /* Reduced from 1px */
    text-transform: uppercase;
    white-space: nowrap;
  }

  .mini-seat {
    width: 3px; /* Reduced from 4px */
    height: 3px; /* Reduced from 4px */
    border-radius: 1.5px; /* Reduced from 2px */
    display: inline-block;
    margin: 0.3px; /* Reduced from 0.5px */
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
  }

  .mini-seat.sold {
    opacity: 0.3 !important;
    background-color: #444 !important;
  }

  /* Layout Structure - More compact */
  .layout-row {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-bottom: 6px; /* Reduced from 8px */
    gap: 10px; /* Reduced from 15px */
  }

  .side-sections {
    display: flex;
    gap: 8px; /* Reduced from 10px */
  }

  .center-section {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  /* Section-specific styling with improved colors */
  .section-vvip {
    background: linear-gradient(135deg, #ff6b35, #f7931e);
    border-color: #ff6b35;
    box-shadow: 0 0 20px rgba(255, 107, 53, 0.4);
  }
  .section-vvip .mini-seat {
    background-color: #ff6b35;
    box-shadow: 0 0 4px rgba(255, 107, 53, 0.7);
  }

  .section-vip-pit, .section-vip-peat {
    background: linear-gradient(135deg, #e91e63, #ad1457);
    border-color: #e91e63;
    box-shadow: 0 0 20px rgba(233, 30, 99, 0.4);
  }
  .section-vip-pit .mini-seat, .section-vip-peat .mini-seat {
    background-color: #e91e63;
    box-shadow: 0 0 4px rgba(233, 30, 99, 0.7);
  }

  .section-vip, .section-vip-seated, .section-vip-standing {
    background: linear-gradient(135deg, #8e44ad, #6a1b9a);
    border-color: #8e44ad;
    box-shadow: 0 0 20px rgba(142, 68, 173, 0.4);
  }
  .section-vip .mini-seat, .section-vip-seated .mini-seat, .section-vip-standing .mini-seat {
    background-color: #8e44ad;
    box-shadow: 0 0 4px rgba(142, 68, 173, 0.7);
  }

  .section-patron-a, .section-gold {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    border-color: #ff9800;
    box-shadow: 0 0 20px rgba(255, 152, 0, 0.4);
  }
  .section-patron-a .mini-seat, .section-gold .mini-seat {
    background-color: #ff9800;
    box-shadow: 0 0 4px rgba(255, 152, 0, 0.7);
  }

  .section-patron-b, .section-silver {
    background: linear-gradient(135deg, #3f51b5, #303f9f);
    border-color: #3f51b5;
    box-shadow: 0 0 20px rgba(63, 81, 181, 0.4);
  }
  .section-patron-b .mini-seat, .section-silver .mini-seat {
    background-color: #3f51b5;
    box-shadow: 0 0 4px rgba(63, 81, 181, 0.7);
  }

  .section-lower-box {
    background: linear-gradient(135deg, #4caf50, #388e3c);
    border-color: #4caf50;
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.4);
  }
  .section-lower-box .mini-seat {
    background-color: #4caf50;
    box-shadow: 0 0 4px rgba(76, 175, 80, 0.7);
  }

  .section-upper-box, .section-upper-box-a, .section-upper-box-b {
    background: linear-gradient(135deg, #795548, #5d4037);
    border-color: #795548;
    box-shadow: 0 0 20px rgba(121, 85, 72, 0.4);
  }
  .section-upper-box .mini-seat, .section-upper-box-a .mini-seat, .section-upper-box-b .mini-seat {
    background-color: #795548;
    box-shadow: 0 0 4px rgba(121, 85, 72, 0.7);
  }

  .section-floor-standing {
    background: linear-gradient(135deg, #f06292, #e91e63);
    border-color: #f06292;
    box-shadow: 0 0 20px rgba(240, 98, 146, 0.4);
  }
  .section-floor-standing .mini-seat {
    background-color: #f06292;
    box-shadow: 0 0 4px rgba(240, 98, 146, 0.7);
  }

  .section-bronze, .section-general-admission {
    background: linear-gradient(135deg, #00bcd4, #0097a7);
    border-color: #00bcd4;
    box-shadow: 0 0 20px rgba(0, 188, 212, 0.4);
  }
  .section-bronze .mini-seat, .section-general-admission .mini-seat {
    background-color: #00bcd4;
    box-shadow: 0 0 4px rgba(0, 188, 212, 0.7);
  }

  /* Responsive adjustments for smaller screens */
  @media (max-width: 768px) {
    .poster-layout-container {
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .layout-section {
      min-width: 300px; /* Reduced from 320px */
      max-width: 360px; /* Reduced from 380px */
    }

    .arena-container {
      padding: 15px; /* Reduced from 20px */
      max-width: 350px;
    }

    .layout-row {
      gap: 6px; /* Reduced from 8px */
    }

    .side-sections {
      gap: 4px; /* Reduced from 5px */
    }

    .venue-layout {
      min-height: 250px; /* Reduced for mobile */
    }
  }

  .accordion-item.bg-dark {
    background-color: #111;
    border: 1px solid #8e44ad;
  }

  .bg-gradient-purple {
    background: linear-gradient(135deg, #8e44ad, #e91e63) !important;
  }

  .bg-black {
    background-color: #000 !important;
  }

  .accordion-button {
    font-weight: 600;
    font-size: 16px;
  }

  .seat-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding: 10px 0;
  }

  .seat-btn {
    width: 56px;
    height: 42px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: bold;
    border: 1px solid #555;
    background: #222;
    color: white;
    transition: all 0.2s ease;
    cursor: pointer;
    padding: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .seat-btn.available { background-color: #444; }
  .seat-btn.sold { background-color: #e74c3c; color: white; cursor: not-allowed; }
  .seat-btn.selected { background-color: #2ecc71; color: white; }

  .seat-btn:hover:not(.sold):not(.selected) {
    transform: scale(1.05);
    border-color: #8e44ad;
  }

  .seat-code {
    font-size: 10px;
    font-weight: 600;
    line-height: 1;
    text-align: center;
  }

  .legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
  }

  .legend-item {
    font-size: 15px;
    font-weight: 500;
    color: #ccc;
  }

  .box {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 5px;
  }

  .box.available { background-color: #999; }
  .box.selected { background-color: #2ecc71; }
  .box.sold { background-color: #e74c3c; }

  .summary-box {
    margin-top: 30px;
    font-size: 18px;
    text-align: center;
    color: #d3adf7;
  }
</style>

<!-- JavaScript -->
<script>
  // Generate code-based seat names
  function generateSeatCode(sectionName, seatIndex, totalSeats) {
    const sectionCodes = {
      'vvip': 'VV',
      'vip peat': 'VP',
      'vip pit': 'VP',
      'vip seated': 'VS',
      'vip standing': 'VT',
      'vip': 'V',
      'floor standing': 'FS',
      'patron a': 'PA',
      'patron b': 'PB',
      'gold': 'G',
      'silver': 'S',
      'bronze': 'B',
      'lower box': 'LB',
      'upper box a': 'UBA',
      'upper box b': 'UBB',
      'upper box': 'UB',
      'general admission': 'GA'
    };

    const normalizedSection = sectionName.toLowerCase();
    let sectionCode = 'GEN';

    for (const [key, code] of Object.entries(sectionCodes)) {
      if (normalizedSection.includes(key)) {
        sectionCode = code;
        break;
      }
    }

    // Calculate seats per row based on section type
    let seatsPerRow = 10;
    if (normalizedSection.includes('vvip') || normalizedSection.includes('vip peat') || normalizedSection.includes('vip pit')) {
      seatsPerRow = 6;
    } else if (normalizedSection.includes('vip')) {
      seatsPerRow = 8;
    } else if (normalizedSection.includes('patron a') || normalizedSection.includes('gold')) {
      seatsPerRow = 10;
    } else if (normalizedSection.includes('patron b') || normalizedSection.includes('silver')) {
      seatsPerRow = 12;
    } else if (normalizedSection.includes('upper box')) {
      seatsPerRow = 8;
    } else if (normalizedSection.includes('lower box')) {
      seatsPerRow = 10;
    } else if (normalizedSection.includes('general admission')) {
      seatsPerRow = 15;
    }

    if (normalizedSection.includes('standing')) {
      const standingNumber = seatIndex + 1;
      return `${sectionCode}-${standingNumber.toString().padStart(3, '0')}`;
    }

    const rowNumber = Math.floor(seatIndex / seatsPerRow) + 1;
    const seatNumber = (seatIndex % seatsPerRow) + 1;
    const rowLetter = String.fromCharCode(64 + rowNumber);
    return `${sectionCode}${rowNumber}-${rowLetter}${seatNumber}`;
  }

  function getSectionClass(sectionName) {
    const name = sectionName.toLowerCase().replace(/\s+/g, '-');
    return `section-${name}`;
  }

  function createArenaSection(sectionName, seats, width = 120, height = 50) {
    const sectionClass = getSectionClass(sectionName);
    const totalSeats = seats.length;
    const seatsToShow = Math.min(totalSeats, Math.floor((width * height) / 20));

    let html = `<div class="arena-section ${sectionClass}" style="width: ${width}px; height: ${height}px; position: relative;">`;
    html += `<div class="section-block">`;

    const rows = Math.ceil(Math.sqrt(seatsToShow / 1.5));
    const seatsPerRow = Math.ceil(seatsToShow / rows);

    for (let i = 0; i < seatsToShow; i++) {
      const seat = seats[i] || ['', '', 'available'];
      const seatStatus = seat[2] || 'available';
      const seatClass = seatStatus === 'sold' ? 'mini-seat sold' : 'mini-seat';
      html += `<span class="${seatClass}"></span>`;
    }

    html += `</div>`;
    html += `<div class="section-label">${sectionName.toUpperCase()}</div>`;
    html += `</div>`;

    return html;
  }

   function renderArenaLayout(categoriesJson) {
    const venueLayout = document.getElementById('venue-layout');
    const sections = {};

    Object.entries(categoriesJson).forEach(([catId, data]) => {
      sections[data.name.toLowerCase()] = data.seats;
    });

    let html = '';
    const s = sections;

    const hasPeat = !!s['vip peat'];
    const hasFloor = !!s['floor standing'];
    const hasSeated = !!s['vip seated'];
    const hasPit = !!s['vip pit'];

    if (hasPeat) {
      html = renderTraditionalLayout(s);    // Layout 1
    } else if (hasFloor) {
      html = renderStandingLayout(s);       // Layout 2
    } else if (hasSeated) {
      html = renderLayoutThree(s);          // Layout 3
    } else if (hasPit) {
      html = renderLayoutFour(s);           // Layout 4
    } else {
      html = renderDefaultLayout(s);        // fallback
    }

    venueLayout.innerHTML = html;
  }

  // ── FIXED: Layout 3 (VVIP → VIP Seated → Gold → Silver → Bronze) ──
  function renderLayoutThree(s) {
    let html = '';
    // CORRECTED ORDER: Most premium to least premium
    const order = ['vvip','vip seated','gold','silver','bronze'];
    order.forEach(name => {
      if (s[name]) {
        html += '<div class="layout-row">' +
                  createArenaSection(name.charAt(0).toUpperCase()+name.slice(1), s[name], 180, 50) +
                '</div>';
      }
    });
    return html;
  }

  // ── FIXED: Layout 4 (VIP PIT → Patron A → Patron B → Upper Box A → Upper Box B) ──
  function renderLayoutFour(s) {
    let html = '';
    // CORRECTED ORDER: Most premium to least premium
    const order = ['vip pit','patron a','patron b','upper box a','upper box b'];
    order.forEach(name => {
      if (s[name]) {
        html += '<div class="layout-row">' +
                  createArenaSection(name.charAt(0).toUpperCase()+name.slice(1), s[name], 180, 50) +
                '</div>';
      }
    });
    return html;
  }

  // ── FIXED: Layout 1 Traditional (VVIP → VIP → Patron A → Patron B → General Admission) ──
  function renderTraditionalLayout(sections) {
    let html = '';

    // CORRECTED: Start with most premium sections closest to stage
    // VVIP and VIP sections first (closest to stage)
    html += '<div class="layout-row">';
    if (sections['vvip']) {
      html += createArenaSection('VVIP', sections['vvip'], 180, 55);
    }
    if (sections['vip peat']) {
      html += createArenaSection('VIP Peat', sections['vip peat'], 180, 55);
    }
    if (sections['vip']) {
      html += createArenaSection('VIP', sections['vip'], 180, 55);
    }
    html += '</div>';

    // Middle tier with side sections (Patron levels)
    html += '<div class="layout-row">';
    html += '<div class="side-sections">';
    if (sections['patron a']) {
      html += createArenaSection('Patron A', sections['patron a'], 100, 55);
    }
    html += '</div>';

    html += '<div class="center-section">';
    // Center space or additional premium seating
    html += '</div>';

    html += '<div class="side-sections">';
    if (sections['patron b']) {
      html += createArenaSection('Patron B', sections['patron b'], 100, 55);
    }
    html += '</div>';
    html += '</div>';

    // Upper tier (furthest from stage)
    html += '<div class="layout-row">';
    if (sections['upper box a']) {
      html += createArenaSection('Upper Box A', sections['upper box a'], 120, 45);
    }
    if (sections['upper box b']) {
      html += createArenaSection('Upper Box B', sections['upper box b'], 120, 45);
    }
    if (sections['upper box']) {
      html += createArenaSection('Upper Box', sections['upper box'], 150, 45);
    }
    if (sections['general admission']) {
      html += createArenaSection('General Admission', sections['general admission'], 200, 45);
    }
    html += '</div>';

    return html;
  }

  // ── FIXED: Layout 2 Standing (Floor Standing → VIP Standing → Lower Box → Upper Box → General Admission) ──
  function renderStandingLayout(sections) {
    let html = '';

    // CORRECTED: Most premium standing areas first (closest to stage)
    html += '<div class="layout-row">';
    if (sections['floor standing']) {
      html += createArenaSection('Floor Standing', sections['floor standing'], 140, 60);
    }
    if (sections['vip standing']) {
      html += createArenaSection('VIP Standing', sections['vip standing'], 140, 60);
    }
    html += '</div>';

    // Lower box (elevated but closer)
    if (sections['lower box']) {
      html += '<div class="layout-row">';
      html += createArenaSection('Lower Box', sections['lower box'], 220, 50);
      html += '</div>';
    }

    // Upper level (furthest from stage)
    if (sections['upper box']) {
      html += '<div class="layout-row">';
      html += createArenaSection('Upper Box', sections['upper box'], 200, 45);
      html += '</div>';
    }

    // General admission (least premium)
    if (sections['general admission']) {
      html += '<div class="layout-row">';
      html += createArenaSection('General Admission', sections['general admission'], 300, 50);
      html += '</div>';
    }

    return html;
  }

  function renderDefaultLayout(sections) {
    let html = '';

    // Create a flexible layout based on available sections
    // Sort sections by premium level for default layout
    const premiumOrder = [
      'vvip', 'vip peat', 'vip pit', 'vip seated', 'vip standing', 'vip',
      'floor standing', 'patron a', 'gold', 'patron b', 'silver',
      'lower box', 'bronze', 'upper box a', 'upper box b', 'upper box',
      'general admission'
    ];

    const sortedSections = [];
    premiumOrder.forEach(sectionKey => {
      if (sections[sectionKey]) {
        sortedSections.push([sectionKey, sections[sectionKey]]);
      }
    });

    // Add any remaining sections not in the premium order
    Object.entries(sections).forEach(([sectionName, seats]) => {
      if (!premiumOrder.includes(sectionName)) {
        sortedSections.push([sectionName, seats]);
      }
    });

    const sectionsPerRow = 3;
    for (let i = 0; i < sortedSections.length; i += sectionsPerRow) {
      html += '<div class="layout-row">';

      for (let j = i; j < Math.min(i + sectionsPerRow, sortedSections.length); j++) {
        const [sectionName, seats] = sortedSections[j];
        const width = sortedSections.length <= 3 ? 150 : 120;
        html += createArenaSection(sectionName, seats, width, 50);
      }

      html += '</div>';
    }

    return html;
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Generate seat codes for all seat buttons
    const seatButtons = document.querySelectorAll(".seat-btn");
    seatButtons.forEach(btn => {
      const sectionName = btn.getAttribute("data-section");
      const seatIndex = parseInt(btn.getAttribute("data-index"));
      const totalSeats = parseInt(btn.getAttribute("data-total"));

      const seatCode = generateSeatCode(sectionName, seatIndex, totalSeats);
      btn.querySelector('.seat-code').textContent = seatCode;
      btn.setAttribute("data-label", seatCode);
    });

    // Get categories data from Flask template
    const categoriesJson = {{ categories_json | tojson }};

    // Render the venue layout
    renderArenaLayout(categoriesJson);

    const selectedSeats = new Set();

    function updateSummary() {
      const selectedArray = Array.from(selectedSeats);
      document.getElementById("selected-seats-input").value = selectedArray.join(",");

      const selectedLabels = Array.from(seatButtons)
        .filter(b => b.classList.contains("selected"))
        .map(b => b.getAttribute("data-label"));

      const total = Array.from(seatButtons)
        .filter(b => b.classList.contains("selected"))
        .map(b => parseFloat(b.getAttribute("data-price")))
        .reduce((sum, p) => sum + p, 0);

      document.getElementById("selected-seats").innerText = selectedLabels.length > 0 ? selectedLabels.join(", ") : "None";
      document.getElementById("total-price").innerText = total.toFixed(2);
    }

    seatButtons.forEach(btn => {
      btn.addEventListener("click", function () {
        if (this.classList.contains("sold")) return;

        const seatId = this.getAttribute("data-id");

        if (this.classList.contains("selected")) {
          this.classList.remove("selected");
          this.classList.add("available");
          selectedSeats.delete(seatId);
        } else {
          this.classList.remove("available");
          this.classList.add("selected");
          selectedSeats.add(seatId);
        }

        updateSummary();
      });
    });

    updateSummary();
  });
</script>

<!-- Bootstrap (for accordion) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}